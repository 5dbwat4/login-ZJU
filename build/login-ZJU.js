/**
 * login-ZJU: A light-weight server-side library helping your application login to ZJU services
 * @author 5dbwat4<me@5dbwat4.top>
 * @version 1.0.4
 */
var m=class{domain;path;secure;script;static All=Object.freeze(Object.create(null));constructor(t,e,i,o){this.domain=t||void 0,this.path=e||"/",this.secure=!!i,this.script=!!o}},M=/[:](?=\s*[a-zA-Z0-9_\-]+\s*[=])/g,f=class r{name=null;value=null;expiration_date=1/0;path="/";explicit_path=!1;domain=null;explicit_domain=!1;secure=!1;noscript=!1;constructor(t,e,i){if(t instanceof r){Object.assign(this,t);return}this.path=String(i||"/"),this.domain=e||null,t&&this.parse(t,e,i)}toString(){let t=[this.name+"="+this.value];return this.expiration_date!==1/0&&t.push("expires="+new Date(this.expiration_date).toUTCString()),this.domain&&t.push("domain="+this.domain),this.path&&t.push("path="+this.path),this.secure&&t.push("secure"),this.noscript&&t.push("httponly"),t.join("; ")}toValueString(){return this.name+"="+this.value}parse(t,e,i){if(typeof t!="string")return;if(t.length>32768){console.warn("Cookie too long for parsing (>32768 characters)");return}let o=t.split(";").filter(Boolean),a=o[0].match(/([^=]+)=([\s\S]*)/);if(!a){console.warn("Invalid cookie header encountered. Header: '"+t+"'");return}let l=a[1],s=a[2];if(typeof l!="string"||l.length===0||typeof s!="string"){console.warn("Unable to extract values from cookie header. Cookie: '"+t+"'");return}this.name=l,this.value=s;for(let n=1;n<o.length;n+=1){let g=o[n].match(/([^=]+)(?:=([\s\S]*))?/);if(g)switch(l=g[1].trim().toLowerCase(),s=g[2],l){case"httponly":this.noscript=!0;break;case"expires":this.expiration_date=s?Number(Date.parse(s)):1/0;break;case"path":this.path=s?s.trim():"",this.explicit_path=!0;break;case"domain":this.domain=s?s.trim():"",this.explicit_domain=!!this.domain;break;case"secure":this.secure=!0;break}}return this.explicit_path||(this.path=i||"/"),this.explicit_domain||(this.domain=e||this.domain),this}matches(t){return t===m.All?!0:!(this.noscript&&t.script||this.secure&&!t.secure||!this.collidesWith(t))}collidesWith(t){if(this.path&&!t.path||this.domain&&!t.domain||this.path&&t.path.indexOf(this.path)!==0||this.explicit_path&&t.path.indexOf(this.path)!==0)return!1;let e=t.domain&&t.domain.replace(/^[\.]/,""),i=this.domain&&this.domain.replace(/^[\.]/,"");if(i===e)return!0;if(i){if(!this.explicit_domain)return!1;let o=e.indexOf(i);return!(o===-1||o!==e.length-i.length)}return!0}},p=class{cookies;constructor(){this.cookies=Object.create(null)}setCookie(t,e,i){let o=t instanceof f?t:new f(t,e,i),a=o.expiration_date<=Date.now(),l=o.name,s=this.cookies[l];if(s!==void 0){for(let n=0;n<s.length;n+=1)if(s[n].collidesWith(o))return a?(s.splice(n,1),s.length===0&&delete this.cookies[l],!1):(s[n]=o,o);return a?!1:(s.push(o),o)}return a?!1:(this.cookies[l]=[o],this.cookies[l])}getCookie(t,e){let i=this.cookies[t];if(i)for(let o=0;o<i.length;o+=1){let a=i[o];if(a.expiration_date<=Date.now()){i.length===0&&delete this.cookies[a.name];continue}if(a.matches(e))return a}}getCookies(t){let e=[];for(let i in this.cookies){let o=this.getCookie(i,t);o&&e.push(o)}return e.toString=function(){return e.join(":")},e.toValueString=function(){return e.map(function(o){return o.toValueString()}).join("; ")},e}setCookies(t,e,i){let o=Array.isArray(t)?t:t.split(M),a=[],l=o.map(s=>s instanceof f?s:new f(s,e,i));for(let s=0;s<l.length;s+=1){let n=l[s];this.setCookie(n,e,i)&&a.push(n)}return a}};function h(){return new p}var I="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36 Edg/142.0.0.0";function Z(r){let t={};if(!r)return t;if(r instanceof Headers){for(let[e,i]of r.entries())t[e.toLowerCase()]=i;return t}if(Array.isArray(r)){for(let[e,i]of r)t[e.toLowerCase()]=i;return t}for(let e of Object.keys(r)){let i=r[e];t[e.toLowerCase()]=String(i)}return t}async function O(r,t,e){let i=e||h(),o=typeof r=="string"?r:r instanceof Request?r.url:String(r),a=new URL(o,"http://localhost"),l=a.hostname,s=a.pathname||"/",n=Z(t&&t.headers?t.headers:void 0),g=new m(l,s,a.protocol==="https:",!1),d=i.getCookies(g),k=d&&d.toValueString?d.toValueString():d.length?d.map(u=>u.toValueString()).join("; "):"";if(k){let u=n.cookie;n.cookie=u?u+"; "+k:k}let w=new Headers;w.set("User-Agent",I);for(let u of Object.keys(n))w.set(u,n[u]);let v=Object.assign({},t,{headers:w}),R=await fetch(r,v),j=[];for(let[u,y]of R.headers)u.toLowerCase()==="set-cookie"&&j.push(y);if(j.length>0)for(let u of j)try{i.setCookies(u,l,s)}catch(y){console.warn("Failed to set cookie from header",u,y)}return R}var c=O;var b=class{zjuamInstance;session="";firstTime=!0;jar=h();constructor(t){this.zjuamInstance=t}async login(){console.log("[COURSES] login begins");let t="https://courses.zju.edu.cn/user/index";for(;new URL(t).hostname!=="zjuam.zju.edu.cn";)console.log("[COURSES] Redirect:",t),t=(await c(t,{redirect:"manual"},this.jar)).headers.get("Location");console.log("[COURSES] Redirected to ZJUAM for authentication:",t),t=await this.zjuamInstance.loginSvc(new URL(t).searchParams.get("service")||""),console.log("[COURSES] Returned from ZJUAM, finalizing login at:",t);let e=await c(t,{redirect:"manual"},this.jar);for(;;){console.log("[COURSES] Redirect:",t);let i=await c(t,{redirect:"manual"},this.jar),o=await i.text();if(i.status==200&&o.includes('meta http-equiv="refresh"')){t=o.match(/meta http-equiv="refresh" content="0;URL=([^"]+)"/)[1];continue}if(!(i.status>=300&&i.status<400))break;t=i.headers.get("Location")}return console.log("[COURSES] Login finalized."),!0}async fetch(t,e={}){return this.firstTime&&(await this.login(),this.firstTime=!1),console.log("[COURSES] Fetching url:",t),e.headers={...e?.headers},c(t,e,this.jar)}};var x=class{zjuamInstance;cookiesJar;logedIn=!1;constructor(t){this.zjuamInstance=t,this.cookiesJar=h()}async login(){await c("https://zdbk.zju.edu.cn/jwglxt/xtgl/login_cxSsoLoginUrl.html",{method:"POST"},this.cookiesJar);let t=await this.zjuamInstance.loginSvc("https://zdbk.zju.edu.cn/jwglxt/xtgl/login_ssologin.html"),e=await c(t,{redirect:"manual"},this.cookiesJar);if(e.status!==302)throw new Error("Login failed, status code is "+e.status);if(!e.headers.get("Location")?.includes("https://zdbk.zju.edu.cn/jwglxt/xtgl/index_initMenu.html"))throw new Error("Login failed, redirect to unexpected url "+e.headers.get("Location"));return!0}async fetch(t,e){return this.logedIn||await this.login().then(i=>this.logedIn=i),c(t,{...e,headers:{...e?.headers}},this.cookiesJar)}};function z(r,t,e){let i=0n;for(let n of r)i=i*256n+BigInt(n.charCodeAt(0));let o=BigInt("0x"+e),a=BigInt("0x"+t);return(i**a%o).toString(16)}var E="https://zjuam.zju.edu.cn/cas/v2/getPubKey",C=class{username;password;jar=h();firstinLogin=!1;constructor(t,e){this.username=t,this.password=e}async#t(t){console.log("[ZJUAM] Attempting to login to ZJUAM.");let e;try{e=await c(t,void 0,this.jar).then(n=>n.text())}catch{return Promise.reject({message:"Failed when fetch login page at first time."})}let i=e.match(/name="execution" value="([^"]+)"/)?.[1]??"";if(!i)return Promise.reject({message:"First-time login page doesn't contain execution string."});let o;try{o=await c(E,void 0,this.jar).then(n=>n.json())}catch{return Promise.reject({message:"Failed when fetch pubkey."})}let a=z(this.password,o.exponent,o.modulus),l=["username="+this.username,"password="+a,"execution="+i,"_eventId=submit","authcode="].join("&"),s={"Content-Type":"application/x-www-form-urlencoded","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0"};try{let n=await c(t,{method:"POST",body:l,headers:s,redirect:"manual"},this.jar);if(n.status===302)return this.firstinLogin=!0,console.log("[ZJUAM] Login success."),n.headers.get("Location");if(n.status===200){let d=(await n.text()).match(/<span id="msg">([^<]+)<\/span>/)?.[1];return Promise.reject({message:"Failed to login: "+d})}else return Promise.reject({message:"Failed to login with status code "+n.status})}catch{return Promise.reject({message:"Failed when posting login."})}}login(){return this.#t("https://zjuam.zju.edu.cn/cas/login")}async fetch(t,e={}){this.firstinLogin||await this.login().catch(o=>{console.error(o)});let i={...e.headers||{},"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0"};return c(t,{...e,headers:i},this.jar)}async loginSvc(t){console.log("[ZJUAM] Attempting to login to service: "+t);let e="https://zjuam.zju.edu.cn/cas/login?service="+encodeURIComponent(t);if(this.firstinLogin){let i=await this.fetch(e,{redirect:"manual",method:"GET"});return console.log("loginSvc,",i.status,i.headers.get("Location")),i.status===302?i.headers.get("Location"):i.status===200?this.#t(e):Promise.reject({message:"Login failed with status "+i.status})}else return this.#t(e)}async loginSvc_oauth2(t){console.log("[ZJUAM] Attempting to login to oauth2 service: "+t);let e=t;for(;new URL(e).hostname==="zjuam.zju.edu.cn";)console.log("[ZJUAM] Redirect:",e),e=(await this.fetch(e,{redirect:"manual",method:"GET"})).headers.get("Location");return e}};import F from"crypto";var J="https://form.zju.edu.cn/",_=r=>Buffer.from(r).toString("base64");var P="74102f635c6d4b22b270239bc1e84f50",T=r=>{let t=F.createCipheriv("aes-128-ecb",Buffer.from(P,"hex"),null),e=t.update(r,"utf8","base64");return e+=t.final("base64"),_(e)},S=class{token="";zjuamInstance;constructor(t){this.zjuamInstance=t}async login(){return console.log("[FORM] login begins"),this.zjuamInstance.loginSvc(J).then(t=>{let e=t.split("ticket=")[1].split("&")[0];return fetch(`https://form.zju.edu.cn/dfi/validateLogin?ticket=${T(e)}&service=${encodeURIComponent(J)}`)}).then(t=>t.json()).then(t=>{if(t.code===2e3)return console.log("[FORM] login success"),this.token=t.data.token,!0;throw new Error("[FORM] login failed",t)}).catch(t=>{throw t})}async fetch(t){this.token===""&&await this.login();try{let e=await fetch(t,{headers:{authentication:this.token}});if(e.status===200)return e;if(e.status===401||e.status===403)return this.token="",this.fetch(t);throw new Error(`Request failed with status ${e.status}`)}catch(e){throw console.error("Fetch error:",e),e}}};var U=class{zjuamInstance;token="";jar=h();constructor(t){this.zjuamInstance=t}async login(){console.log("[CLASSROOM] Attempting to login to classroom.zju.edu.cn");let t="https://tgmedia.cmc.zju.edu.cn/index.php?r=auth%2Flogin&forward=https%3A%2F%2Fclassroom.zju.edu.cn%2F";for(;new URL(t).hostname!=="zjuam.zju.edu.cn";)console.log("[CLASSROOM] Redirect:",t),t=(await c(t,{redirect:"manual"},this.jar)).headers.get("Location");for(console.log("[CLASSROOM] Redirected to ZJUAM for authentication:",t),t=await this.zjuamInstance.loginSvc_oauth2(t),console.log("[CLASSROOM] Returned from ZJUAM, finalizing login at:",t);;){console.log("[CLASSROOM] Redirect:",t);let e=await c(t,{redirect:"manual"},this.jar),i=await e.text();if(e.status==200&&i.includes('meta http-equiv="refresh"')){t=i.match(/meta http-equiv="refresh" content="0;URL=([^"]+)"/)[1];continue}if(!(e.status>=300&&e.status<400))break;t=e.headers.get("Location")}}async fetch(t,e={}){(!this.token||this.token.length===0)&&await this.login(),console.log("[CLASSROOM] Fetching:",t);let i={...e.headers,Authorization:`Bearer ${this.token}`};return c(t,{...e,headers:i},this.jar)}};var A=class{#t;#e=h();#i=!0;constructor(t){this.#t=t}async login(){let t="https://yqfkgl.zju.edu.cn/_web/_customizes/ykt/index3.jsp";console.log("[YQFKGL] login begins"),await c(t,{redirect:"manual"},this.#e);let e=await this.#t.loginSvc(t).catch(console.log);if(!e)throw new Error("[YQFKGL] loginSvc failed");console.log("[YQFKGL] Redirecting to ZJUAM for authentication:",e),await c(e,{redirect:"manual"},this.#e),this.#i=!1,console.log("[YQFKGL] login finished")}async fetch(t,e={}){return this.#i&&await this.login(),c(t,e,this.#e)}};var L="1.0.4";console.log("[login ZJU] You (or your application) are using login-ZJU version: "+L);console.log("[login ZJU] If you find any issues, please report them at");console.log("                https://github.com/5dbwat4/login-ZJU");export{U as CLASSROOM,b as COURSES,S as FORM,A as YQFKGL,x as ZDBK,C as ZJUAM};
//# sourceMappingURL=login-ZJU.js.map
