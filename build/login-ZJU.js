/**
 * login-ZJU: A server-side library helping your application login to ZJU services
 * @author 5dbwat4<me@5dbwat4.top>
 * @version 1.0.0
 */
var g={};function z(r,t){let e=new URL(r).host;return g[e]=g[e]||{},g[e]&&(t.headers={Cookie:Object.entries(g[e]).map(([s,o])=>`${s}=${o}`).join("; ")}),t.redirect="manual",fetch(r,t).then(s=>(s.headers.get("set-cookie")&&s.headers.getSetCookie().forEach(o=>{let[i,c]=o.split("=");g[e][i]=c}),s))}var l=z;var m=class{constructor(t){this.session="";this.firstTime=!0;this.zjuamInstance=t}async login(){return console.log("[COURSES] login begins"),l("https://courses.zju.edu.cn/user/index",{redirect:"manual"}).then(t=>{if(t.status==302)return l(t.headers.get("Location"),{redirect:"manual"});throw new Error("Fail at first load.")}).then(t=>{if(t.status==303)return l(t.headers.get("Location"),{redirect:"manual"});throw new Error("Fail at first load.")}).then(async t=>{if(t.status==303){let e=await this.zjuamInstance.loginSvc(decodeURIComponent(t.headers.get("Location").replace("https://zjuam.zju.edu.cn/cas/login?service=","")));return l(e,{redirect:"manual"})}else throw new Error("Fail at first load.")}).then(t=>{if(t.status==302)return l(t.headers.get("Location"),{redirect:"manual"});throw new Error("Fail at first load.")}).then(t=>{if(t.status==302)return console.log("[COURSES] Login success!"),this.session=t.headers.get("Set-Cookie").split(";")[0].split("=")[1],!0;throw new Error("Fail at login.")})}async fetch(t,e={}){return this.firstTime&&(await this.login(),this.firstTime=!1),console.log("[COURSES] Fetching url:",t),e.headers={Cookie:"session="+this.session+";"},fetch(t,e).then(s=>{if(s.headers.get("Set-Cookie")){let o=s.headers.get("Set-Cookie").split(";")[0].split("=")[1];o!==this.session&&(this.session=o)}return s})}};var d=class{constructor(t){this.zjuamInstance=t,this.cookies={}}async login(){let t=await this.zjuamInstance.loginSvc("http://zdbk.zju.edu.cn/jwglxt/xtgl/login_ssologin.html");fetch(t,{redirect:"manual"}).then(e=>{e.headers.getSetCookie().forEach(s=>{if(s.includes("Path=/javajw;"))return;let[o,i]=s.split(";")[0].split("=");this.cookies[o]=i}),e.status==302&&e.headers.get("Location")?.includes("http://zdbk.zju.edu.cn/jwglxt/xtgl/index_initMenu.html")&&fetch(e.headers.get("Location"),{redirect:"manual",headers:{Cookie:Object.entries(this.cookies).map(([s,o])=>`${s}=${o}`).join("; ")}}).then(s=>{s.headers.getSetCookie().forEach(o=>{let[i,c]=o.split(";")[0].split("=");this.cookies[i]=c})})})}};function y(r,t,e){let s=0n;for(let j of r)s=s*256n+BigInt(j.charCodeAt(0));let o=BigInt("0x"+e),i=BigInt("0x"+t);return(s**i%o).toString(16)}var C="https://zjuam.zju.edu.cn/cas/v2/getPubKey";var f=class{constructor(t,e){this.username=t,this.password=e,this.cookies={}}#t(t){return console.log("[ZJUAM] Attempting to login to ZJUAM."),new Promise(async(e,s)=>{let i=(await fetch(t).then(n=>(n.headers.getSetCookie().forEach(a=>{let[h,u]=a.split(";")[0].split("=");this.cookies[h]=u}),n.text())).catch(n=>{s({message:"Failed when fetch login page at first time."})})).match(/name="execution" value="([^"]+)"/)?.[1]??"";i||s({message:"First-time login page doesn't contain execution string."});let c=await fetch(C,{headers:{Cookie:Object.entries(this.cookies).map(([n,a])=>`${n}=${a}`).join("; ")}}).then(n=>(n.headers.getSetCookie().forEach(a=>{let[h,u]=a.split(";")[0].split("=");this.cookies[h]=u}),n.json())).catch(n=>{s({message:"Failed when fetch pubkey."})}),w=y(this.password,c.exponent,c.modulus),j=await fetch(t,{method:"POST",body:["username="+this.username,"password="+w,"execution="+i,"_eventId=submit","authcode="].join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0",Cookie:Object.entries(this.cookies).map(([n,a])=>`${n}=${a}`).join("; ")},redirect:"manual"}).then(async n=>{if(n.headers.getSetCookie().forEach(a=>{let[h,u]=a.split(";")[0].split("=");this.cookies[h]=u}),n.status===302)this.firstinLogin=!0,console.log("[ZJUAM] Login success."),e(n.headers.get("Location"));else if(n.status===200){let h=(await n.text()).match(/\<span id=\"msg\"\>([^<]+)<\/span>/)?.[1];s({message:"Failed to login: "+h})}else s({message:"Failed to login with status code "+n.status})})})}login(){return this.#t("https://zjuam.zju.edu.cn/cas/login")}async fetch(t,e={}){return this.firstinLogin||await this.login().catch(s=>{console.error(s)}),e.headers={...e.headers,Cookie:Object.entries(this.cookies).map(([s,o])=>`${s}=${o}`).join("; "),"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0"},fetch(t,e)}async loginSvc(t){console.log("[ZJUAM] Attempting to login to service: "+t);let e="https://zjuam.zju.edu.cn/cas/login?service="+encodeURIComponent(t);return this.firstinLogin?await this.fetch(e,{redirect:"manual",method:"GET"}).then(s=>(console.log("loginSvc,",s.status,s.headers.get("Location")),s.status==302?s.headers.get("Location"):s.status==200?this.#t(e):Promise.reject({message:"Login failed with status "+s.status}))):this.#t(e)}};var p=class{constructor(t,e){this.token="";this.zjuamInstance=t,this.cookies={}}async login(){let t=await this.zjuamInstance.loginSvc("https://course.zju.edu.cn/ua/login?platform=WEB");console.log(t),await fetch(t,{redirect:"manual"}).then(e=>(console.log(e.status),console.log(e.headers.getSetCookie()),e.headers.getSetCookie().forEach(s=>{let[o,i]=s.split(";")[0].split("=");this.cookies[o]=i}),e.headers.get("Location"))).then(e=>fetch(e,{redirect:"manual",headers:{Cookie:Object.entries(this.cookies).map(([s,o])=>`${s}=${o}`).join("; ")}})).then(e=>(console.log(e.status),console.log(e.headers.getSetCookie()),console.log(e.headers.get("Location")),this.token=new URL(e.headers.get("Location")).searchParams.get("token"),fetch(e.headers.get("Location"),{}))).then(e=>{console.log(e.status),console.log(e.headers.getSetCookie()),console.log(e.headers.get("Location"))})}};var x="https://form.zju.edu.cn/",k=class{constructor(t){this.token="";this.zjuamInstance=t}async login(){return console.log("[FORM] login begins"),this.zjuamInstance.loginSvc(x).then(t=>{let e=t.split("ticket=")[1].split("&")[0];return fetch(`https://form.zju.edu.cn/dfi/validateLogin?ticket=${e}&service=${encodeURIComponent(x)}`)}).then(t=>t.json()).then(t=>{if(t.code===2e3)return console.log("[FORM] login success"),this.token=t.data.token,!0}).catch(t=>{throw t})}async fetch(t){this.token===""&&await this.login();try{let e=await fetch(t,{headers:{authentication:this.token}});if(e.status===200)return e;if(e.status===401||e.status===403)return this.token="",this.fetch(t);throw new Error(`Request failed with status ${e.status}`)}catch(e){throw console.error("Fetch error:",e),e}}};export{p as COURSE,m as COURSES,k as FORM,d as ZDBK,f as ZJUAM};
//# sourceMappingURL=login-ZJU.js.map
