
/**
 * login-ZJU: A server-side library helping your application login to ZJU services
 * @author 5dbwat4<me@5dbwat4.top>
 * @version 1.0.0
 */
var g={};function y(r,e){let t=new URL(r).host;return g[t]=g[t]||{},g[t]&&(e.headers={Cookie:Object.entries(g[t]).map(([o,s])=>`${o}=${s}`).join("; ")}),e.redirect="manual",fetch(r,e).then(o=>(o.headers.get("set-cookie")&&o.headers.getSetCookie().forEach(s=>{let[n,c]=s.split("=");g[t][n]=c}),o))}var h=y;var d=class{constructor(e){this.session="";this.firstTime=!0;this.zjuamInstance=e}async login(){return console.log("[COURSES] login begins"),h("https://courses.zju.edu.cn/user/index",{redirect:"manual"}).then(e=>{if(e.status==302)return h(e.headers.get("Location"),{redirect:"manual"});throw new Error("Fail at first load.")}).then(e=>{if(e.status==303)return h(e.headers.get("Location"),{redirect:"manual"});throw new Error("Fail at first load.")}).then(async e=>{if(e.status==303){let t=await this.zjuamInstance.loginSvc(decodeURIComponent(e.headers.get("Location").replace("https://zjuam.zju.edu.cn/cas/login?service=","")));return h(t,{redirect:"manual"})}else throw new Error("Fail at first load.")}).then(e=>{if(e.status==302)return h(e.headers.get("Location"),{redirect:"manual"});throw new Error("Fail at first load.")}).then(e=>{if(e.status==302)return console.log("[COURSES] Login success!"),this.session=e.headers.get("Set-Cookie").split(";")[0].split("=")[1],!0;throw new Error("Fail at login.")})}async fetch(e,t={}){return this.firstTime&&(await this.login(),this.firstTime=!1),console.log("[COURSES] Fetching url:",e),t.headers={Cookie:"session="+this.session+";"},fetch(e,t).then(o=>{if(o.headers.get("Set-Cookie")){let s=o.headers.get("Set-Cookie").split(";")[0].split("=")[1];s!==this.session&&(this.session=s)}return o})}};var m=class{constructor(e){this.zjuamInstance=e,this.cookies={}}async login(){let e=await this.zjuamInstance.loginSvc("http://zdbk.zju.edu.cn/jwglxt/xtgl/login_ssologin.html");fetch(e,{redirect:"manual"}).then(t=>{t.headers.getSetCookie().forEach(o=>{if(o.includes("Path=/javajw;"))return;let[s,n]=o.split(";")[0].split("=");this.cookies[s]=n}),t.status==302&&t.headers.get("Location")?.includes("http://zdbk.zju.edu.cn/jwglxt/xtgl/index_initMenu.html")&&fetch(t.headers.get("Location"),{redirect:"manual",headers:{Cookie:Object.entries(this.cookies).map(([o,s])=>`${o}=${s}`).join("; ")}}).then(o=>{o.headers.getSetCookie().forEach(s=>{let[n,c]=s.split(";")[0].split("=");this.cookies[n]=c})})})}};function j(r,e,t){let o=0n;for(let w of r)o=o*256n+BigInt(w.charCodeAt(0));let s=BigInt("0x"+t),n=BigInt("0x"+e);return(o**n%s).toString(16)}var x="https://zjuam.zju.edu.cn/cas/v2/getPubKey";var f=class{constructor(e,t){this.username=e,this.password=t,this.cookies={}}#t(e){return console.log("[ZJUAM] Attempting to login to ZJUAM."),new Promise(async(t,o)=>{let n=(await fetch(e).then(i=>(i.headers.getSetCookie().forEach(a=>{let[l,u]=a.split(";")[0].split("=");this.cookies[l]=u}),i.text())).catch(i=>{o({message:"Failed when fetch login page at first time."})})).match(/name="execution" value="([^"]+)"/)?.[1]??"";n||o({message:"First-time login page doesn't contain execution string."});let c=await fetch(x,{headers:{Cookie:Object.entries(this.cookies).map(([i,a])=>`${i}=${a}`).join("; ")}}).then(i=>(i.headers.getSetCookie().forEach(a=>{let[l,u]=a.split(";")[0].split("=");this.cookies[l]=u}),i.json())).catch(i=>{o({message:"Failed when fetch pubkey."})}),k=j(this.password,c.exponent,c.modulus),w=await fetch(e,{method:"POST",body:["username="+this.username,"password="+k,"execution="+n,"_eventId=submit","authcode="].join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0",Cookie:Object.entries(this.cookies).map(([i,a])=>`${i}=${a}`).join("; ")},redirect:"manual"}).then(async i=>{if(i.headers.getSetCookie().forEach(a=>{let[l,u]=a.split(";")[0].split("=");this.cookies[l]=u}),i.status===302)this.firstinLogin=!0,console.log("[ZJUAM] Login success."),t(i.headers.get("Location"));else if(i.status===200){let l=(await i.text()).match(/\<span id=\"msg\"\>([^<]+)<\/span>/)?.[1];o({message:"Failed to login: "+l})}else o({message:"Failed to login with status code "+i.status})})})}login(){return this.#t("https://zjuam.zju.edu.cn/cas/login")}async fetch(e,t={}){return this.firstinLogin||await this.login().catch(o=>{console.error(o)}),t.headers={...t.headers,Cookie:Object.entries(this.cookies).map(([o,s])=>`${o}=${s}`).join("; "),"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36 Edg/131.0.0.0"},fetch(e,t)}async loginSvc(e){console.log("[ZJUAM] Attempting to login to service: "+e);let t="https://zjuam.zju.edu.cn/cas/login?service="+encodeURIComponent(e);return this.firstinLogin?await this.fetch(t,{redirect:"manual",method:"GET"}).then(o=>(console.log("loginSvc,",o.status,o.headers.get("Location")),o.status==302?o.headers.get("Location"):o.status==200?this.#t(t):Promise.reject({message:"Login failed with status "+o.status}))):this.#t(t)}};var p=class{constructor(e,t){this.token="";this.zjuamInstance=e,this.cookies={}}async login(){let e=await this.zjuamInstance.loginSvc("https://course.zju.edu.cn/ua/login?platform=WEB");console.log(e),await fetch(e,{redirect:"manual"}).then(t=>(console.log(t.status),console.log(t.headers.getSetCookie()),t.headers.getSetCookie().forEach(o=>{let[s,n]=o.split(";")[0].split("=");this.cookies[s]=n}),t.headers.get("Location"))).then(t=>fetch(t,{redirect:"manual",headers:{Cookie:Object.entries(this.cookies).map(([o,s])=>`${o}=${s}`).join("; ")}})).then(t=>(console.log(t.status),console.log(t.headers.getSetCookie()),console.log(t.headers.get("Location")),this.token=new URL(t.headers.get("Location")).searchParams.get("token"),fetch(t.headers.get("Location"),{}))).then(t=>{console.log(t.status),console.log(t.headers.getSetCookie()),console.log(t.headers.get("Location"))})}};export{p as COURSE,d as COURSES,m as ZDBK,f as ZJUAM};
//# sourceMappingURL=login-ZJU.js.map
